name: Kubernetes Performance Testing CI

on:
  push:
    branches:
      - main

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install kubectl
    - name: Install kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    # Install kind
    - name: Install kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    # Create ephemeral cluster
    - name: Create kind cluster
      run: kind create cluster

    # Build nginx Docker image
    - name: Build nginx image
      run: docker build -t perf-nginx ./app

    # Load image into kind
    - name: Load image into kind
      run: kind load docker-image perf-nginx

    # Deploy Kubernetes manifests
    - name: Deploy to Kubernetes
      run: kubectl apply -f k8s/

    # Wait for nginx pod
    - name: Wait for Nginx
      run: kubectl rollout status deployment/nginx-deployment

    # Run JMeter Job
    - name: Wait for JMeter Job to Complete
      run: |
        kubectl wait --for=condition=complete job/jmeter-job --timeout=120s

    # Copy reports from JMeter pod
    - name: Copy JMeter Report
      run: |
        mkdir reports
        POD=$(kubectl get pods --selector=job-name=jmeter-job -o jsonpath='{.items[0].metadata.name}')
        kubectl cp $POD:/report ./reports

    # Upload report as artifact
    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: k8s-performance-report
        path: reports

    # Cleanup
    - name: Delete kind cluster
      run: kind delete cluster
