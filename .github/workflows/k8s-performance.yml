name: Kubernetes Performance Test CI

on:
  push:
    branches:
      - main

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:

    # 1Ô∏è‚É£ Checkout code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Install Kind
    - name: Install Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    # 3Ô∏è‚É£ Create Kind Cluster
    - name: Create Kind Cluster
      run: |
        kind create cluster --name perf-cluster
        kubectl get nodes

    # 4Ô∏è‚É£ Build nginx Docker image
    - name: Build Nginx Image
      run: |
        docker build -t perf-nginx:latest ./app

    # 5Ô∏è‚É£ Load image into Kind
    - name: Load Image into Kind
      run: |
        kind load docker-image perf-nginx:latest --name perf-cluster

    # 6Ô∏è‚É£ Deploy Kubernetes Resources
    - name: Deploy Kubernetes Manifests
      run: |
        kubectl apply -f k8s/

    # 7Ô∏è‚É£ Wait for Nginx to be Ready
    - name: Wait for Nginx Deployment
      run: |
        kubectl rollout status deployment/nginx-deployment --timeout=120s

    # 8Ô∏è‚É£ Run JMeter Job
    - name: Apply JMeter Job
      run: |
        kubectl apply -f k8s/jmeter-job.yaml

    # 9Ô∏è‚É£ Wait for JMeter to Complete (with debug)
    - name: Wait for JMeter Job to Complete
      run: |
        kubectl wait --for=condition=complete job/jmeter-job --timeout=180s || true
        echo "----- JOB STATUS -----"
        kubectl get jobs
        echo "----- POD STATUS -----"
        kubectl get pods
        echo "----- JMETER LOGS -----"
        POD=$(kubectl get pods --selector=job-name=jmeter-job -o jsonpath='{.items[0].metadata.name}')
        kubectl logs $POD

    # üîü Copy JMeter Report from Pod
    - name: Copy Report
      run: |
        mkdir -p reports
        POD=$(kubectl get pods --selector=job-name=jmeter-job -o jsonpath='{.items[0].metadata.name}')
        kubectl cp $POD:/results ./reports

    # 1Ô∏è‚É£1Ô∏è‚É£ Upload Artifact
    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: k8s-performance-report
        path: reports

    # 1Ô∏è‚É£2Ô∏è‚É£ Cleanup Cluster
    - name: Delete Kind Cluster
      if: always()
      run: |
        kind delete cluster --name perf-cluster
