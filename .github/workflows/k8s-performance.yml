name: Kubernetes Performance Test CI

on:
  push:
    branches:
      - main

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Create Kind Cluster
      run: |
        kind create cluster --name perf-cluster
        kubectl get nodes

    - name: Build Nginx Image
      run: docker build -t perf-nginx:latest ./app

    - name: Load Image into Kind
      run: kind load docker-image perf-nginx:latest --name perf-cluster

    - name: Deploy MySQL
      run: kubectl apply -f k8s/mysql-deployment.yaml

    - name: Deploy Nginx
      run: kubectl apply -f k8s/nginx-deployment.yaml

    - name: Deploy Service
      run: kubectl apply -f k8s/nginx-service.yaml

    - name: Wait for Nginx Deployment
      run: kubectl rollout status deployment/nginx-deployment --timeout=120s

    # ðŸ”¥ IMPORTANT FIX â€” CREATE CONFIGMAP
    - name: Create JMeter ConfigMap
      run: |
        kubectl create configmap jmeter-config \
        --from-file=jmeter/Ephemeral_cicd.jmx

    - name: Apply JMeter Job
      run: kubectl apply -f k8s/jmeter-job.yaml

    - name: Wait for JMeter Job
      run: kubectl wait --for=condition=complete job/jmeter-job --timeout=300s

    - name: Copy Report
      run: |
        mkdir reports
        POD=$(kubectl get pod -l job-name=jmeter-job -o jsonpath="{.items[0].metadata.name}")
        kubectl cp $POD:/results/report ./reports

    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: k8s-performance-report
        path: reports

    - name: Cleanup
      if: always()
      run: kind delete cluster --name perf-cluster